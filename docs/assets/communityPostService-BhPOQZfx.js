var P=Object.defineProperty,R=Object.defineProperties;var L=Object.getOwnPropertyDescriptors;var v=Object.getOwnPropertySymbols;var O=Object.prototype.hasOwnProperty,q=Object.prototype.propertyIsEnumerable;var b=(t,r,e)=>r in t?P(t,r,{enumerable:!0,configurable:!0,writable:!0,value:e}):t[r]=e,E=(t,r)=>{for(var e in r||(r={}))O.call(r,e)&&b(t,e,r[e]);if(v)for(var e of v(r))q.call(r,e)&&b(t,e,r[e]);return t},k=(t,r)=>R(t,L(r));var n=(t,r,e)=>new Promise((o,a)=>{var s=d=>{try{c(e.next(d))}catch(m){a(m)}},l=d=>{try{c(e.throw(d))}catch(m){a(m)}},c=d=>d.done?o(d.value):Promise.resolve(d.value).then(s,l);c((e=e.apply(t,r)).next())});import{s as i}from"./index-Dp-8Rdet.js";const T={uploadMedia(t,r,e=0){return n(this,null,function*(){try{const o=t.name.split(".").pop(),s=`community-media/${`${r}/${Date.now()}-${Math.random().toString(36).substring(7)}.${o}`}`,l=t.type.startsWith("video/")?"video":t.type==="image/gif"?"gif":"photo",{data:c,error:d}=yield i.storage.from("community-posts").upload(s,t,{cacheControl:"3600",upsert:!1});if(d)throw d;const{data:{publicUrl:m}}=i.storage.from("community-posts").getPublicUrl(s);let _;l==="video"&&(_=yield this.generateVideoThumbnail(t));let y,p,w;if(l==="photo"){const u=yield this.getImageDimensions(t);y=u.width,p=u.height}else l==="video"&&(w=yield this.getVideoDuration(t));const{data:h,error:g}=yield i.from("post_media").insert({post_id:r,media_type:l,media_url:m,thumbnail_url:_,width:y,height:p,duration:w,file_size:t.size,mime_type:t.type,display_order:e,processing_status:"completed"}).select().single();if(g)throw g;return{media_id:h.id,media_url:m,thumbnail_url:_,processing_status:"completed"}}catch(o){return console.error("Error uploading media:",o),null}})},uploadMultipleMedia(t,r){return n(this,null,function*(){try{const e=t.map((a,s)=>this.uploadMedia(a,r,s));return(yield Promise.all(e)).filter(a=>a!==null)}catch(e){return console.error("Error uploading multiple media:",e),[]}})},deleteMedia(t){return n(this,null,function*(){try{const{data:r,error:e}=yield i.from("post_media").select("media_url").eq("id",t).single();if(e)throw e;const o=r.media_url.split("/"),a=o.slice(o.indexOf("community-media")).join("/"),{error:s}=yield i.storage.from("community-posts").remove([a]);if(s)throw s;const{error:l}=yield i.from("post_media").delete().eq("id",t);if(l)throw l;return!0}catch(r){return console.error("Error deleting media:",r),!1}})},getImageDimensions(t){return n(this,null,function*(){return new Promise(r=>{const e=new Image,o=URL.createObjectURL(t);e.onload=()=>{URL.revokeObjectURL(o),r({width:e.width,height:e.height})},e.onerror=()=>{URL.revokeObjectURL(o),r({width:0,height:0})},e.src=o})})},getVideoDuration(t){return n(this,null,function*(){return new Promise(r=>{const e=document.createElement("video"),o=URL.createObjectURL(t);e.onloadedmetadata=()=>{URL.revokeObjectURL(o),r(Math.floor(e.duration))},e.onerror=()=>{URL.revokeObjectURL(o),r(0)},e.src=o})})},generateVideoThumbnail(t){return n(this,null,function*(){return new Promise(r=>{const e=document.createElement("video"),o=document.createElement("canvas"),a=URL.createObjectURL(t);e.onloadeddata=()=>{e.currentTime=1},e.onseeked=()=>{o.width=e.videoWidth,o.height=e.videoHeight;const s=o.getContext("2d");if(s){s.drawImage(e,0,0,o.width,o.height);const l=o.toDataURL("image/jpeg",.8);URL.revokeObjectURL(a),r(l)}else URL.revokeObjectURL(a),r(void 0)},e.onerror=()=>{URL.revokeObjectURL(a),r(void 0)},e.src=a})})},getPostMedia(t){return n(this,null,function*(){try{const{data:r,error:e}=yield i.from("post_media").select("*").eq("post_id",t).order("display_order",{ascending:!0});if(e)throw e;return r||[]}catch(r){return console.error("Error fetching post media:",r),[]}})},validateFile(t){const r=t.type.startsWith("video/")?104857600:10485760;return t.size>r?{valid:!1,error:`File size exceeds maximum allowed (${r/(1024*1024)}MB)`}:["image/jpeg","image/jpg","image/png","image/gif","image/webp","video/mp4","video/webm","video/quicktime"].includes(t.type)?{valid:!0}:{valid:!1,error:"File type not supported. Please upload JPEG, PNG, GIF, WebP, MP4, or WebM files."}},validateFiles(t){const r=[];return t.length>4&&r.push("Maximum 4 media items allowed per post"),t.forEach((e,o)=>{const a=this.validateFile(e);!a.valid&&a.error&&r.push(`File ${o+1}: ${a.error}`)}),{valid:r.length===0,errors:r}}},f={getProfile(t){return n(this,null,function*(){try{const{data:r,error:e}=yield i.from("profiles").select("*").eq("user_id",t).single();if(e)throw e;return r}catch(r){return console.error("Error fetching profile:",r),null}})},getProfileByUsername(t){return n(this,null,function*(){try{const{data:r,error:e}=yield i.from("profiles").select("*").eq("username",t).single();if(e)throw e;return r}catch(r){return console.error("Error fetching profile by username:",r),null}})},upsertProfile(t){return n(this,null,function*(){try{const{data:r,error:e}=yield i.from("profiles").upsert(t,{onConflict:"user_id"}).select().single();if(e)throw e;return r}catch(r){return console.error("Error upserting profile:",r),null}})},searchProfiles(t,r=20){return n(this,null,function*(){try{const{data:e,error:o}=yield i.from("profiles").select("*").or(`username.ilike.%${t}%,display_name.ilike.%${t}%`).limit(r);if(o)throw o;return e||[]}catch(e){return console.error("Error searching profiles:",e),[]}})}},U={getFeed(){return n(this,arguments,function*(t={}){try{const{category:r,author_id:e,following_only:o=!1,limit:a=20,offset:s=0,sort_by:l="latest"}=t;let c=i.from("community_posts").select(`
          *,
          author:profiles!community_posts_author_id_fkey(*),
          media:post_media(*)
        `,{count:"exact"}).is("deleted_at",null).range(s,s+a-1);if(r&&(c=c.eq("category",r)),e&&(c=c.eq("author_id",e)),o){const{data:{user:w}}=yield i.auth.getUser();if(w){const{data:h}=yield i.from("user_follows").select("following_id").eq("follower_id",w.id);if(h&&h.length>0){const g=h.map(u=>u.following_id);c=c.in("author_id",g)}}}switch(l){case"popular":c=c.order("like_count",{ascending:!1});break;case"trending":c=c.order("view_count",{ascending:!1});break;case"latest":default:c=c.order("created_at",{ascending:!1})}const{data:d,error:m,count:_}=yield c;if(m)throw m;const{data:{user:y}}=yield i.auth.getUser();let p=d||[];if(y&&p.length>0){const w=p.map(u=>u.id),{data:h}=yield i.from("post_likes").select("post_id").eq("user_id",y.id).in("post_id",w),g=new Set((h==null?void 0:h.map(u=>u.post_id))||[]);p=p.map(u=>k(E({},u),{user_has_liked:g.has(u.id)}))}return{posts:p,has_more:(_||0)>s+a,total_count:_||0}}catch(r){return console.error("Error fetching feed:",r),{posts:[],has_more:!1,total_count:0}}})},getPost(t){return n(this,null,function*(){try{const{data:r,error:e}=yield i.from("community_posts").select(`
          *,
          author:profiles!community_posts_author_id_fkey(*),
          media:post_media(*)
        `).eq("id",t).is("deleted_at",null).single();if(e)throw e;return yield i.from("community_posts").update({view_count:(r.view_count||0)+1}).eq("id",t),r}catch(r){return console.error("Error fetching post:",r),null}})},createPost(t){return n(this,null,function*(){var r;try{const{data:{user:e}}=yield i.auth.getUser();if(!e)throw new Error("User not authenticated");const o=yield f.getProfile(e.id);if(!o)throw new Error("Profile not found");const{data:a,error:s}=yield i.from("community_posts").insert({author_id:o.id,content:t.content,category:t.category||"general",location:t.location,latitude:t.latitude,longitude:t.longitude,is_public:(r=t.is_public)!=null?r:!0,tags:t.tags||[],mentions:t.mentions||[]}).select(`
          *,
          author:profiles!community_posts_author_id_fkey(*)
        `).single();if(s)throw s;return t.tags&&t.tags.length>0&&(yield this.updateHashtags(t.tags)),a}catch(e){return console.error("Error creating post:",e),null}})},updatePost(t,r){return n(this,null,function*(){try{const{data:e,error:o}=yield i.from("community_posts").update({content:r.content,location:r.location,is_public:r.is_public,tags:r.tags,updated_at:new Date().toISOString()}).eq("id",t).select(`
          *,
          author:profiles!community_posts_author_id_fkey(*),
          media:post_media(*)
        `).single();if(o)throw o;return r.tags&&(yield this.updateHashtags(r.tags)),e}catch(e){return console.error("Error updating post:",e),null}})},deletePost(t){return n(this,null,function*(){try{const{error:r}=yield i.from("community_posts").update({deleted_at:new Date().toISOString()}).eq("id",t);if(r)throw r;return!0}catch(r){return console.error("Error deleting post:",r),!1}})},updateHashtags(t){return n(this,null,function*(){try{for(const r of t){const e=r.toLowerCase().replace("#","");yield i.rpc("increment_hashtag_usage",{tag_name:e})}}catch(r){console.error("Error updating hashtags:",r)}})}},S={getComments(t,r=50){return n(this,null,function*(){try{const{data:e,error:o}=yield i.from("post_comments").select(`
          *,
          author:profiles!post_comments_author_id_fkey(*)
        `).eq("post_id",t).is("deleted_at",null).is("parent_comment_id",null).order("created_at",{ascending:!1}).limit(r);if(o)throw o;return yield Promise.all((e||[]).map(s=>n(this,null,function*(){const l=yield this.getReplies(s.id);return k(E({},s),{replies:l})})))}catch(e){return console.error("Error fetching comments:",e),[]}})},getReplies(t){return n(this,null,function*(){try{const{data:r,error:e}=yield i.from("post_comments").select(`
          *,
          author:profiles!post_comments_author_id_fkey(*)
        `).eq("parent_comment_id",t).is("deleted_at",null).order("created_at",{ascending:!0});if(e)throw e;return r||[]}catch(r){return console.error("Error fetching replies:",r),[]}})},createComment(t){return n(this,null,function*(){try{const{data:{user:r}}=yield i.auth.getUser();if(!r)throw new Error("User not authenticated");const e=yield f.getProfile(r.id);if(!e)throw new Error("Profile not found");const{data:o,error:a}=yield i.from("post_comments").insert({post_id:t.post_id,author_id:e.id,content:t.content,parent_comment_id:t.parent_comment_id}).select(`
          *,
          author:profiles!post_comments_author_id_fkey(*)
        `).single();if(a)throw a;return o}catch(r){return console.error("Error creating comment:",r),null}})},deleteComment(t){return n(this,null,function*(){try{const{error:r}=yield i.from("post_comments").update({deleted_at:new Date().toISOString()}).eq("id",t);if(r)throw r;return!0}catch(r){return console.error("Error deleting comment:",r),!1}})}},j={likePost(t){return n(this,null,function*(){try{const{data:{user:r}}=yield i.auth.getUser();if(!r)throw new Error("User not authenticated");const e=yield f.getProfile(r.id);if(!e)throw new Error("Profile not found");const{error:o}=yield i.from("post_likes").insert({user_id:e.id,post_id:t});if(o)throw o;return!0}catch(r){return console.error("Error liking post:",r),!1}})},unlikePost(t){return n(this,null,function*(){try{const{data:{user:r}}=yield i.auth.getUser();if(!r)throw new Error("User not authenticated");const e=yield f.getProfile(r.id);if(!e)throw new Error("Profile not found");const{error:o}=yield i.from("post_likes").delete().eq("user_id",e.id).eq("post_id",t);if(o)throw o;return!0}catch(r){return console.error("Error unliking post:",r),!1}})},likeComment(t){return n(this,null,function*(){try{const{data:{user:r}}=yield i.auth.getUser();if(!r)throw new Error("User not authenticated");const e=yield f.getProfile(r.id);if(!e)throw new Error("Profile not found");const{error:o}=yield i.from("post_likes").insert({user_id:e.id,comment_id:t});if(o)throw o;return!0}catch(r){return console.error("Error liking comment:",r),!1}})},unlikeComment(t){return n(this,null,function*(){try{const{data:{user:r}}=yield i.auth.getUser();if(!r)throw new Error("User not authenticated");const e=yield f.getProfile(r.id);if(!e)throw new Error("Profile not found");const{error:o}=yield i.from("post_likes").delete().eq("user_id",e.id).eq("comment_id",t);if(o)throw o;return!0}catch(r){return console.error("Error unliking comment:",r),!1}})}},D={followUser(t){return n(this,null,function*(){try{const{data:{user:r}}=yield i.auth.getUser();if(!r)throw new Error("User not authenticated");const e=yield f.getProfile(r.id);if(!e)throw new Error("Profile not found");const{error:o}=yield i.from("user_follows").insert({follower_id:e.id,following_id:t});if(o)throw o;return!0}catch(r){return console.error("Error following user:",r),!1}})},unfollowUser(t){return n(this,null,function*(){try{const{data:{user:r}}=yield i.auth.getUser();if(!r)throw new Error("User not authenticated");const e=yield f.getProfile(r.id);if(!e)throw new Error("Profile not found");const{error:o}=yield i.from("user_follows").delete().eq("follower_id",e.id).eq("following_id",t);if(o)throw o;return!0}catch(r){return console.error("Error unfollowing user:",r),!1}})},getFollowers(t,r=50){return n(this,null,function*(){try{const{data:e,error:o}=yield i.from("user_follows").select("follower:profiles!user_follows_follower_id_fkey(*)").eq("following_id",t).limit(r);if(o)throw o;return(e==null?void 0:e.map(a=>a.follower))||[]}catch(e){return console.error("Error fetching followers:",e),[]}})},getFollowing(t,r=50){return n(this,null,function*(){try{const{data:e,error:o}=yield i.from("user_follows").select("following:profiles!user_follows_following_id_fkey(*)").eq("follower_id",t).limit(r);if(o)throw o;return(e==null?void 0:e.map(a=>a.following))||[]}catch(e){return console.error("Error fetching following:",e),[]}})},isFollowing(t,r){return n(this,null,function*(){try{const{data:e,error:o}=yield i.from("user_follows").select("id").eq("follower_id",t).eq("following_id",r).maybeSingle();if(o)throw o;return!!e}catch(e){return console.error("Error checking follow status:",e),!1}})}},$={inviteUsers(t,r,e){return n(this,null,function*(){try{const{data:{user:o}}=yield i.auth.getUser();if(!o)throw new Error("User not authenticated");const a=yield f.getProfile(o.id);if(!a)throw new Error("Profile not found");const s=r.map(c=>({post_id:t,inviter_id:a.id,invitee_id:c,message:e||null,status:"pending"})),{error:l}=yield i.from("post_invites").insert(s);if(l)throw l;return!0}catch(o){return console.error("Error inviting users:",o),!1}})},respondToInvite(t,r){return n(this,null,function*(){try{const{error:e}=yield i.from("post_invites").update({status:r,responded_at:new Date().toISOString()}).eq("id",t);if(e)throw e;return!0}catch(e){return console.error("Error responding to invite:",e),!1}})},getPendingInvites(t){return n(this,null,function*(){try{const{data:r,error:e}=yield i.from("post_invites").select(`
          *,
          inviter:profiles!post_invites_inviter_id_fkey(*),
          post:community_posts(*)
        `).eq("invitee_id",t).eq("status","pending").order("created_at",{ascending:!1});if(e)throw e;return r||[]}catch(r){return console.error("Error fetching invites:",r),[]}})}},C={bookmarkPost(t){return n(this,null,function*(){try{const{data:{user:r}}=yield i.auth.getUser();if(!r)throw new Error("User not authenticated");const e=yield f.getProfile(r.id);if(!e)throw new Error("Profile not found");const{error:o}=yield i.from("post_bookmarks").insert({user_id:e.id,post_id:t});if(o)throw o;return!0}catch(r){return console.error("Error bookmarking post:",r),!1}})},removeBookmark(t){return n(this,null,function*(){try{const{data:{user:r}}=yield i.auth.getUser();if(!r)throw new Error("User not authenticated");const e=yield f.getProfile(r.id);if(!e)throw new Error("Profile not found");const{error:o}=yield i.from("post_bookmarks").delete().eq("user_id",e.id).eq("post_id",t);if(o)throw o;return!0}catch(r){return console.error("Error removing bookmark:",r),!1}})},getBookmarks(t,r=50){return n(this,null,function*(){try{const{data:e,error:o}=yield i.from("post_bookmarks").select(`
          *,
          post:community_posts(
            *,
            author:profiles!community_posts_author_id_fkey(*),
            media:post_media(*)
          )
        `).eq("user_id",t).order("created_at",{ascending:!1}).limit(r);if(o)throw o;return e||[]}catch(e){return console.error("Error fetching bookmarks:",e),[]}})}},F={subscribeToFeed(t,r){let e=i.channel("community_feed").on("postgres_changes",{event:"INSERT",schema:"public",table:"community_posts",filter:t?`category=eq.${t}`:void 0},o=>n(null,null,function*(){const a=yield U.getPost(o.new.id);a&&r(a)})).subscribe();return()=>{i.removeChannel(e)}},subscribeToComments(t,r){let e=i.channel(`post_comments_${t}`).on("postgres_changes",{event:"INSERT",schema:"public",table:"post_comments",filter:`post_id=eq.${t}`},o=>n(null,null,function*(){const{data:a}=yield i.from("post_comments").select("*, author:profiles!post_comments_author_id_fkey(*)").eq("id",o.new.id).single();a&&r(a)})).subscribe();return()=>{i.removeChannel(e)}}},x={profile:f,post:U,comment:S,like:j,follow:D,invite:$,bookmark:C,realtime:F};export{x as c,T as m};
